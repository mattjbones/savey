<!DOCTYPE html>
<html>
    <head>
        <title>Savey</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="styles.css">
        <style>
            * {
                text-align: center;
            }
            main {
                max-width: 38rem;
                padding: 2rem;
                margin: auto;
            }
            html {
                border: 0;
                margin: 0;
                padding: 0;
                width: 100%;
                height: auto;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
            }

            body {
                background-color: #702ACD;
                padding: 0;
                margin: 0;
                height: auto;
                width: 100%;
                font-size: larger;
                color: #1ecbe1;
                font-family: sans-serif;
            }

            footer {
                margin-top: 20vh;
                padding-bottom: 20px;
                max-width: 38rem;
                margin-left: auto;
                margin-right: auto;
                font-size: small;
            }

            header { 
                width: 100%;
            }

            h1 { 
                color: #1ecbe1;
                font-family: sans-serif;
                margin-bottom: 0;
            }

        </style>
    </head>
    <body>
        <main>
            <h1>52 week challenge: Calendars</h1>
            <p class="subtitle"><em>Each week, save a little more - &pound;1 to be precise.</em></p> 
            <div class="custom-dropdown">
                <select id="day-sel" required>
                    <option hidden value="0">Select start day</option>
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Saturday</option>
                    <option value="7">Sunday</option>
                </select>
                <!-- add input for "reverse" mode -->
            </div>

            <div class="buttons-container"> 
                <a href="#" class="button nav-link" id="gen-csv">
                    <div class="bottom"></div>
                    <div class="top">
                        <div class="label">CSV</div>
                        
                        <div class="button-border button-border-left"></div>
                        <div class="button-border button-border-top"></div>
                        <div class="button-border button-border-right"></div>
                        <div class="button-border button-border-bottom"></div>
                    </div>
                </a>

                <a href="#" class="button nav-link" id="gen-ical">
                    <div class="bottom"></div>
                    <div class="top">
                        <div class="label">iCal</div>
                        <div class="button-border button-border-left"></div>
                        <div class="button-border button-border-top"></div>
                        <div class="button-border button-border-right"></div>
                        <div class="button-border button-border-bottom"></div>
                    </div>
                </a>

                <a href="#" class="button nav-link" id="gen-gcal">
                    <div class="bottom"></div>
                    <div class="top">
                        <div class="label">gCal</div>
                        <div class="button-border button-border-left"></div>
                        <div class="button-border button-border-top"></div>
                        <div class="button-border button-border-right"></div>
                        <div class="button-border button-border-bottom"></div>
                    </div>
                </a>
            </div>

            <div class="uwot-container">
                <p>
                    Generate a calendar for the app of your choosing with an entry, on a day of your choosing, 
                    reminding you to transfer money as part of the <span class="red">52 week saving challenge</span>. 
                </p>
                <p>
                    Each week put away an increasing (or decreasing) amount of mouney, for a year, with the aim of building a nice little pot of money. 
                </p>
                <p>
                    If you start today, with just <span class="red">&pound;1, $1, &euro;1 or &sect;1</span> by the time 52 weeks have passed 
                    you'll have saved <span class="red">&pound;1,379</span> (or currency of your choice). 
                </p>
            </div>

            <div id="result"></div>
        </main>
        <footer>
            <div>
                Made with &#x2661; by <a href="https://twitter.com/mattjbones">mattjbones</a>.
            </div>
            <div> 
                Button CSS taken from <a href="https://codepen.io/halvo/pen/pRdeja">here</a>.
            </div>
            <div>
                Colour palette created with <a href="https://www.canva.com/colors/color-wheel/">Canva's Colour Wheel</a>, check it out. 
            </div>
            <div>
                Selector styling adapted from <a href="https://speckyboy.com/open-source-css-javascript-select-box-snippets/">Non-Sucky HTML Dropdowns</a>.
            </div>
        </footer>

        <script>
            const subjectPrefix = "52 Week Savings";
            const defaultStart = "12:00 PM";
            const defaultEnd = "12:15 PM";
            const defaultDay = 1;

            const getSelectedDay = function () {
                return parseInt(document.getElementById('day-sel').value, 10);
            }

            const getCsvDateString = function (date){
                return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
            }

            const getIcalDateString = function (date){
                const month = date.getMonth() + 1
                const monthString = month < 10 ? "0" + month : "" + month;

                const day = date.getDate();
                const dayString = day < 10 ? "0" + day : "" + day;

                return `${date.getFullYear()}${monthString}${dayString}`;
            }

            const generateData = function (){

                const todaysDate = new Date();
                const startDay = getSelectedDay() || defaultDay;
                const today = todaysDate.getDay();
                const isTodayStartDay = startDay === today;

                const differenceMillis = (today > startDay ? today + startDay : startDay - today)*60*60*1000*24;
                const startDate = isTodayStartDay ? todaysDate : new Date(Date.now() + differenceMillis);
                
                const data = [];
                let total = 1; 
                while (data.length < 53){
                    const week = data.length;
                    const difference = (week) * 60 * 60 * 24 * 7 * 1000;
                    const weekDate = new Date(startDate.getTime() + difference); 

                    total += week;

                    const line = {
                        subject:`${subjectPrefix}: Transfer \u00A3${week}`,   
                        startDate: weekDate,
                        startTime: defaultStart,
                        endDate: weekDate,
                        endTime: defaultEnd,
                        allDay: false, 
                        description: `Week ${week}: total saved ${total}`,
                        uid: `${weekDate.getTime()}-${week}-${total}`
                    };

                    data.push(line);
                }
                return data;
            };

            const downloadFile = function (filename, data) {
                var blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
                if(window.navigator.msSaveOrOpenBlob) {
                    window.navigator.msSaveBlob(blob, filename);
                }
                else{
                    var elem = window.document.createElement('a');
                    elem.href = window.URL.createObjectURL(blob);
                    elem.download = filename;        
                    document.body.appendChild(elem);
                    elem.click();        
                    requestAnimationFrame(function (){ document.body.removeChild(elem)});
                }
            };

            const csvButton = document.getElementById('gen-csv');            
            csvButton.onclick = function (e) {
                event.preventDefault();
                const csvHeader = ["Subject", "Start Date", "Start Time", "End Date", "End Time", "All Day", "Description", "Location", "UID" ];
                const csvSaveData = generateData()
                    .map(({subject, startDate, startTime, endDate, endTime, allDay, description, uid}) =>
                        ([subject, startDate, startTime, endDate, endTime, allDay, description, undefined, uid]) 
                     );
                const final = [ csvHeader, ...csvSaveData ];
                downloadFile('52 week challenge.csv', final.map(e => e.join(",")).join("\n"));
            };

            const icalButton = document.getElementById('gen-ical');
            icalButton.onclick = function() {
                event.preventDefault();
                const data = generateData();
                const header = [
                    "BEGIN:VCALENDAR",
                    "VERSION:2.0",
                    "PRODID:-//Savey//Savey Calendar 1.0//EN",
                    "CALSCALE:GREGORIAN",
                    "METHOD:PUBLISH"
                ];

                const footer = "END:VCALENDAR";

                const createEntry = function (data){
                    return [
                        "BEGIN:VEVENT",
                        `SUMMARY:${data.subject}`,
                        `UID:${data.uid}`,
                        "SEQUENCE:0",
                        "STATUS:CONFIRMED",
                        "TRANSP:TRANSPARENT",
                        `DTSTART:${getIcalDateString(data.startDate)}`,
                        `DTEND:${getIcalDateString(data.endDate)}`,
                        `DTSTAMP:${getIcalDateString(data.startDate)}T140000`,
                        `DESCRIPTION:${data.description}`,
                        "END:VEVENT"
                    ];
                };

                const final = [
                    header.join('\r\n'),
                    ...data.map(entry => createEntry(entry).join('\r\n')),
                    footer
                ].join('\r\n');
                downloadFile(`${subjectPrefix}.ics`, final);
            };

            
            const gcalButton = document.getElementById('gen-gcal');
            gcalButton.onclick = function () {
                event.preventDefault();
                const data = generateData();
                alert("Coming soon!");
            };
            
            const result = document.getElementById('result');
            const print = function (string){
                result.innerHTML += `<p>${string}</p>`;
            };
        </script>
    </body>
</html>